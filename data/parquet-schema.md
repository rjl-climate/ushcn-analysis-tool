# USHCN Parquet File Schema Documentation

This document describes the structure and schema of parquet files generated by the USHCN data downloader. This documentation is designed for AI metaprogramming instructions and automated data processing.

## File Structure Overview

The USHCN downloader generates the following parquet files:

### Daily Data Files
- **Filename Pattern**: `ushcn-daily-{YYYY-MM-DD}.parquet`
- **Source**: GHCN (Global Historical Climatology Network) daily data
- **Format**: Long format (one row per measurement)
- **Coordinate Coverage**: 100% (all rows have lat/lon)

### Monthly Data Files
- **Filename Pattern**: `ushcn-monthly-{dataset}-{YYYY-MM-DD}.parquet`
- **Source**: USHCN (US Historical Climatology Network) monthly data
- **Datasets**: `raw`, `tob`, `fls52`
- **Format**: Wide format (one row per station per month)
- **Coordinate Coverage**: 100% (all rows have lat/lon)

### Station Metadata Files
- **USHCN Stations**: `ushcn-stations-{YYYY-MM-DD}.parquet` (1,218 stations)
- **GHCN Stations**: `ghcnd-stations-{YYYY-MM-DD}.parquet` (129,000+ stations)

## Schema Definitions

### Daily Data Schema (`ushcn-daily-*.parquet`)

```
id: string (NOT NULL)
  - Station identifier (e.g., "USC00137147")
  - Format: GHCN station ID
  
date: date32 (NULLABLE)
  - Measurement date
  - Format: YYYY-MM-DD
  
element: string (NOT NULL)
  - Measurement type
  - Values: "TMAX", "TMIN", "PRCP", "SNOW", "SNWD", etc.
  
dataset: string (NOT NULL)
  - Always "UNKNOWN" for daily data
  - Legacy field from processing pipeline
  
value: float32 (NULLABLE)
  - Measurement value
  - Units: Celsius for temperature, mm for precipitation
  - Missing values: NULL
  
lat: float32 (NULLABLE)
  - Station latitude in decimal degrees
  - Coverage: 100% for all valid rows
  - Range: Approximately 18°N to 71°N
  
lon: float32 (NULLABLE)
  - Station longitude in decimal degrees  
  - Coverage: 100% for all valid rows
  - Range: Approximately -178°W to -65°W
```

**Row Count**: ~37.9M rows
**Data Density**: 100% coordinate coverage, ~32% measurement coverage (varies by element)

### Monthly Data Schema (`ushcn-monthly-*.parquet`)

```
id: string (NOT NULL)
  - Station identifier (e.g., "USH00231037")
  - Format: USHCN station ID
  
date: date32 (NULLABLE)
  - Month date (always 1st of month)
  - Format: YYYY-MM-01
  
max_raw: float32 (NULLABLE)
  - Monthly maximum temperature, original data
  - Units: Degrees Celsius
  - Populated only in RAW dataset files
  
max_tob: float32 (NULLABLE)
  - Monthly maximum temperature, time-of-observation adjusted
  - Units: Degrees Celsius
  - Populated only in TOB dataset files
  
max_fls52: float32 (NULLABLE)
  - Monthly maximum temperature, fully corrected
  - Units: Degrees Celsius
  - Populated only in FLS52 dataset files
  
min_raw: float32 (NULLABLE)
  - Monthly minimum temperature, original data
  - Units: Degrees Celsius
  - Populated only in RAW dataset files
  
min_tob: float32 (NULLABLE)
  - Monthly minimum temperature, time-of-observation adjusted
  - Units: Degrees Celsius
  - Populated only in TOB dataset files
  
min_fls52: float32 (NULLABLE)
  - Monthly minimum temperature, fully corrected
  - Units: Degrees Celsius
  - Populated only in FLS52 dataset files
  
avg_raw: float32 (NULLABLE)
  - Monthly average temperature, original data
  - Units: Degrees Celsius
  - Populated only in RAW dataset files
  
avg_tob: float32 (NULLABLE)
  - Monthly average temperature, time-of-observation adjusted
  - Units: Degrees Celsius
  - Populated only in TOB dataset files
  
avg_fls52: float32 (NULLABLE)
  - Monthly average temperature, fully corrected
  - Units: Degrees Celsius
  - Populated only in FLS52 dataset files
  
lat: float32 (NULLABLE)
  - Station latitude in decimal degrees
  - Coverage: 100% for all valid rows
  - Range: Approximately 21°N to 69°N
  
lon: float32 (NULLABLE)
  - Station longitude in decimal degrees
  - Coverage: 100% for all valid rows
  - Range: Approximately -158°W to -65°W
```

**Row Count**: ~5.3-5.9M rows per file
**Data Density**: 100% coordinate coverage, ~32-33% temperature coverage per metric
**Temperature Range**: -35°C to +50°C (realistic bounds)

## Dataset Quality Levels

### RAW Dataset
- **Description**: Original unadjusted measurements as received from stations
- **Use Case**: Baseline data, trend analysis without corrections
- **Coverage**: Historical data from 1875-present

### TOB Dataset  
- **Description**: Time-of-observation bias corrected data
- **Use Case**: Analysis requiring diurnal bias corrections
- **Coverage**: Historical data from 1875-present

### FLS52 Dataset
- **Description**: Fully homogenized and corrected data (version 52j)
- **Use Case**: Climate trend analysis, official climate statistics
- **Coverage**: Historical data from 1875-present
- **Note**: Most comprehensive quality control applied

## Programming Instructions

### Data Loading Examples

```python
# Load daily data
import pandas as pd
daily_df = pd.read_parquet("ushcn-daily-2025-06-27.parquet")

# Load monthly data (all quality levels)
raw_monthly = pd.read_parquet("ushcn-monthly-raw-2025-06-27.parquet")
tob_monthly = pd.read_parquet("ushcn-monthly-tob-2025-06-27.parquet")
fls52_monthly = pd.read_parquet("ushcn-monthly-fls52-2025-06-27.parquet")
```

### Data Processing Guidelines

1. **Coordinate Validation**: All rows should have valid lat/lon coordinates
2. **Temperature Bounds**: Valid temperature range is -50°C to +60°C
3. **Missing Data**: Handle NULL values appropriately
4. **Date Handling**: Monthly dates are always first of month
5. **Unit Consistency**: All temperatures in Celsius, precipitation in mm

### Query Patterns

```python
# Filter by temperature element (daily data)
tmax_data = daily_df[daily_df['element'] == 'TMAX']

# Get maximum temperatures by quality level (monthly data)
max_temps_raw = raw_monthly[['id', 'date', 'max_raw', 'lat', 'lon']].dropna()
max_temps_corrected = fls52_monthly[['id', 'date', 'max_fls52', 'lat', 'lon']].dropna()

# Spatial filtering by bounding box
region_data = daily_df[
    (daily_df['lat'] >= 30.0) & (daily_df['lat'] <= 45.0) &
    (daily_df['lon'] >= -100.0) & (daily_df['lon'] <= -80.0)
]
```

## Data Integrity Checks

```python
# Verify coordinate coverage
assert daily_df['lat'].notna().all(), "Daily data missing coordinates"
assert raw_monthly['lat'].notna().all(), "Monthly data missing coordinates"

# Verify temperature ranges
temp_cols = ['max_raw', 'min_raw', 'avg_raw']
for col in temp_cols:
    temps = raw_monthly[col].dropna()
    assert temps.between(-50, 60).all(), f"Invalid temperature range in {col}"

# Verify date consistency (monthly data)
monthly_dates = pd.to_datetime(raw_monthly['date'])
assert (monthly_dates.dt.day == 1).all(), "Monthly dates not first of month"
```

## File Versioning

Files are versioned by generation date in filename: `{type}-{YYYY-MM-DD}.parquet`
- Always use the most recent date for current analysis
- Archive older versions for reproducibility
- Data content is cumulative (includes all historical records)

## Compression and Performance

- **Compression**: SNAPPY compression applied
- **Optimization**: Dictionary encoding for string columns
- **Performance**: Optimized for column-wise operations
- **File Sizes**: Daily ~500MB, Monthly ~50-100MB each